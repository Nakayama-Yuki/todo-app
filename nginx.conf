# nginx プロセスを実行するユーザーを指定（セキュリティのため非rootで実行）
user nginx;
# ワーカープロセス数を自動設定（CPUコア数に合わせる）
worker_processes auto;
# エラーログの出力先と詳細度（warn = 警告以上）
error_log /var/log/nginx/error.log warn;
# nginxマスタープロセスのPIDファイル保存先
pid /var/run/nginx.pid;

# イベント処理設定ブロック
events {
    # 1つのワーカープロセスが同時に処理できるコネクション数
    worker_connections 1024;
}

# HTTPレベルの設定ブロック（Webサーバーの主要設定）
http {
    # MIMEタイプのマッピングを読み込む（ファイル形式の判定に使用）
    include /etc/nginx/mime.types;
    # MIME タイプが不明な場合のデフォルト
    default_type application/octet-stream;

    # プロキシキャッシュゾーンの定義（キャッシュディレクトリ、メモリサイズ、キャッシュ保持期間）
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=nextjs_cache:10m max_size=100m inactive=60m use_temp_path=off;

    # プロキシキャッシュゾーンの定義（キャッシュディレクトリ、メモリサイズ、最大サイズ、期限）
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=nextjs_cache:10m max_size=100m inactive=60m use_temp_path=off;

    # アクセスログのフォーマット定義
    # $remote_addr: クライアントIP、$remote_user: 認証ユーザー、$time_local: 時刻
    # $request: HTTPリクエスト行、$status: HTTPステータスコード
    # $body_bytes_sent: レスポンスボディサイズ、$http_referer: リファラー
    # $http_user_agent: ユーザーエージェント、$http_x_forwarded_for: プロキシ経由の元クライアントIP
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # アクセスログの出力先とフォーマット指定
    access_log /var/log/nginx/access.log main;

    # ファイルディスクリプタの高速送信（OSレベルのコピー）を有効化
    sendfile on;
    # TCP_NOPUSH: 複数の小さいパケットを1つにまとめて送信（効率化）
    tcp_nopush on;
    # TCP_NODELAY: Nagleアルゴリズムを無効化（低遅延化）
    tcp_nodelay on;
    # クライアントとの接続を保持する時間（秒）
    keepalive_timeout 65;
    # MIME タイプのハッシュテーブル最大サイズ
    types_hash_max_size 2048;
    # クライアントが送信できるボディの最大サイズ（20MB）
    client_max_body_size 20M;

    # Gzip圧縮の有効化（ブラウザへの送信データサイズを削減）
    gzip on;
    # Vary: Accept-Encodingヘッダを追加（キャッシュの最適化）
    gzip_vary on;
    # プロキシからのレスポンスも圧縮対象に（X-Forwarded-Forヘッダがある場合）
    gzip_proxied any;
    # 圧縮レベル（1-9、デフォルト6）：高いほど圧縮率は上がるがCPU使用率も増加
    gzip_comp_level 6;
    # 圧縮対象のMIMEタイプ（テキスト・JavaScript・JSON等を圧縮、画像は対象外）
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;

    # Next.jsアプリケーションのアップストリーム（バックエンドサーバー）定義
    # ロードバランシング時の複数サーバー指定や、単一サーバーの場合もこの形式を使用
    upstream nextjs_upstream {
        # Dockerコンテナ内でのサービス名と公開ポート
        server app:3000;
    }

    # HTTPリクエストを拒否する設定
    server {
        listen 80;
        server_name _;
        # すべてのHTTPリクエストを拒否（400 Bad Request）
        return 400;
    }

    # 仮想ホスト設定（ポート443でHTTPSリクエストを受け付ける）
    server {
        # HTTPS（ポート443）でリッスン、SSL/TLS対応
        listen 443 ssl http2;
        # ホスト名の指定（localhostまたはIPアドレスでアクセス可能）
        server_name localhost;

        # SSL証明書とキーのパス
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        # SSL/TLSプロトコルバージョン（TLS 1.2以上）
        ssl_protocols TLSv1.2 TLSv1.3;
        # 暗号スイートの指定（強力な暗号化方式を優先）
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # HSTSヘッダ設定（ブラウザに対してHTTPSのみを強制、有効期限31日）
        add_header Strict-Transport-Security "max-age=2592000; includeSubDomains; preload" always;

        # ヘルスチェック用エンドポイント（Kubernetes等のオーケストレーション用）
        location /health {
            # ヘルスチェックはアクセスログに記録しない（ログノイズ削減）
            access_log off;
            # 200 OKと"healthy"テキストを返す
            return 200 "healthy\n";
            # レスポンスヘッダにContent-Typeを明示
            add_header Content-Type text/plain;
        }
        location /_next/static/ {
            # キャッシュゾーンを指定
            proxy_cache nextjs_cache;
            # キャッシュの有効期限（60日間）
            proxy_cache_valid 60d;
            # バックエンドから返されたCache-Controlヘッダを無視してキャッシュ
            proxy_ignore_headers Cache-Control;
            # リクエストをNext.jsアプリケーションにプロキシ
            proxy_pass http://nextjs_upstream;
            # クライアントには1年間のキャッシュを指示（immutable = 内容は変わらない）
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # パブリックディレクトリの静的ファイルキャッシング（7日間）
        location /public/ {
            # キャッシュゾーンを指定
            proxy_cache nextjs_cache;
            # キャッシュの有効期限（7日間）
            proxy_cache_valid 7d;
            # バックエンドのCache-Controlを無視
            proxy_ignore_headers Cache-Control;
            # リクエストをNext.jsにプロキシ
            proxy_pass http://nextjs_upstream;
            # クライアントには7日間のキャッシュを指示
            add_header Cache-Control "public, max-age=604800";
        }
            # バックエンドのCache-Controlを無視
            proxy_ignore_headers Cache-Control;
            # リクエストをNext.jsにプロキシ
            proxy_pass http://nextjs_upstream;
            # クライアントには7日間のキャッシュを指示
            add_header Cache-Control "public, max-age=604800";
        }

        # すべてのその他のリクエストをNext.jsアプリケーションにプロキシ
        location / {
            # リクエストをアップストリームサーバーに転送
            proxy_pass http://nextjs_upstream;
            # HTTPバージョンを1.1に設定（WebSocketやアップグレード対応）
            proxy_http_version 1.1;
            # WebSocketやプロトコルアップグレード用のヘッダ
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            # オリジナルホスト名をバックエンドに通知
            proxy_set_header Host $host;
            # クライアントの本当のIPアドレスをバックエンドに通知
            proxy_set_header X-Real-IP $remote_addr;
            # プロキシチェーン内のすべてのクライアントIPを記録
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # 元のリクエストプロトコル（http/https）をバックエンドに通知
            proxy_set_header X-Forwarded-Proto $scheme;
            # アップグレードヘッダがある場合、バックエンドのレスポンスを使用（キャッシュをバイパス）
            proxy_cache_bypass $http_upgrade;
        }

        # WebSocket対応の特別なプロキシ設定（/api/wsエンドポイント用）
        location /api/ws {
            # WebSocketリクエストをバックエンドにプロキシ
            proxy_pass http://nextjs_upstream;
            # HTTP/1.1が必須（WebSocket用）
            proxy_http_version 1.1;
            # プロトコルアップグレード用ヘッダ
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            # その他の必要なヘッダ設定
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
