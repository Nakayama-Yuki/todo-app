# このワークフローは、Next.js + PostgreSQL + pnpmプロジェクトの
# ビルド、Lint、単体テスト、E2Eテストを効率的に実行します
# 詳細: https://docs.github.com/ja/actions/tutorials/build-and-test-code/nodejs

name: Node.js CI(pnpm)

# ワークフローのトリガー条件
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  merge_group:
    # GitHub のマージキューによるトリガー
    types: [checks_requested]

permissions:
  contents: read

jobs:
  # ========================================
  # ジョブ1: Build - Next.jsビルド（独立実行）
  # ========================================
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Use Node.js LTS
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            ${{ github.workspace }}/.next/cache
          # キャッシュキー: OS + pnpm-lock.yaml のハッシュ + ソースコードのハッシュ
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          # キャッシュ未ヒット時のフォールバックパス
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-

      - name: Build project
        run: pnpm run build

      # ビルド成果物を後続ジョブで利用するためにキャッシュに保存
      - name: Save build cache
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.pnpm-store
            ${{ github.workspace }}/.next
          # キャッシュキーに GitHub SHA を含めてユニークにする
          key: ${{ runner.os }}-nextjs-build-${{ github.sha }}

  # ========================================
  # ジョブ2: Unit Tests - Vitestで単体テスト実行（ビルド後）
  # ========================================
  unit-test:
    needs: build
    runs-on: ubuntu-latest

    env:
      # GitHub Secrets から環境変数を設定（データベース接続情報）
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      # Next.js が使用するデータベース接続URL
      DATABASE_URL: postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.POSTGRES_DB }}

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Use Node.js LTS
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Initialize database
        run: |
          set -e
          # init.sql を実行してデータベーススキーマを初期化
          psql -h localhost -p 5432 -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -f init.sql
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

      - name: Run unit tests
        run: pnpm test --run

  # ========================================
  # ジョブ3: E2E Tests - Playwrightで統合テスト実行（単体テスト後）
  # ========================================
  e2e-test:
    # unit-test ジョブが完了してから実行（依存関係）
    needs: unit-test
    runs-on: ubuntu-latest

    env:
      # GitHub Secrets から環境変数を設定（データベース接続情報）
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      # 本番ビルドで E2E テストを実行
      DATABASE_URL: postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.POSTGRES_DB }}
      NODE_ENV: production

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Use Node.js LTS
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Restore build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.pnpm-store
            ${{ github.workspace }}/.next
          # build ジョブで作成されたキャッシュを復元
          key: ${{ runner.os }}-nextjs-build-${{ github.sha }}
          # キャッシュが見つからない場合はエラーで失敗
          fail-on-cache-miss: true

      - name: Initialize database
        run: |
          set -e
          psql -h localhost -p 5432 -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -f init.sql
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run E2E tests
        run: pnpm test:e2e

      - name: Upload Playwright report
        # テストの成功/失敗に関わらず実行（レポートは常に必要）
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
